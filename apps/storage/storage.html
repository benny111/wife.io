<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>

    <!-- Import JQuery library -->
    <script src="http://%SYSIP%:8001/lib/jquery/jquery-1.11.1.min.js"></script>

    <!-- Import Foundation Frameworks -->
    <script src="http://%SYSIP%:8001/lib/framework/foundation/foundation.js"></script>

    <!-- Import UI Frameworks -->
    <script src="http://%SYSIP%:8001/lib/framework/ui/ui-kits.js"></script>

    <!-- Import JQuery Flot library -->
    <script src="js/jquery.flot.js"></script>
    <script src="js/jquery.flot.pie.js"></script>

    <!-- Import Storage style -->
    <link href="css/style.css" rel="stylesheet">

    <script>
        /* StorageViewController Constructor */
        function StorageViewController() {
            this._super = CoreClient;
            this.storageClient = new StorageClient();
        };

        /* Inherit CoreClient */
        StorageViewController.prototype = new CoreClient();
        StorageViewController.prototype.constructor = StorageViewController;

        function setContentWidth()
        {
            var windowWidth = $(document).width();
            var blockWidth = $('.storage-container').outerWidth(true);
            var maxBoxPerRow = Math.floor(windowWidth / blockWidth);
            $('#content').width(maxBoxPerRow * blockWidth);
        }

        $(window).resize(function(){
            setContentWidth();
        });

        $(function() {
            var storageViewController = new StorageViewController();

            storageViewController.event.on("core.connection#established", function(event) {
                storageViewController.storageClient.attach(storageViewController);
            });

            storageViewController.event.on("core.connection#closed", function(event) {
                storageViewController.storageClient.detach();
            });

            storageViewController.event.on("core.connection#error", function(event, error) {});

            storageViewController.event.on("core.protospec#loaded", function(event) {
                var self = storageViewController;

                self.storageClient.getLocalDisks();
                self.storageClient.event.on("storage.localdisk#list#success", function(event, disks) {
                    if (disks.system) {
                        $("#content").append(
                            "<div id='system-container' class='storage-container'> \
                                <h3 id='system-title' align='left'></h3> \
                                <div id='system-placeholder' class='storage-placeholder'></div> \
                            </div>"
                        );

                        $("#system-title").text("System (" + disks.system.mountpoint + ") (" + disks.system.total + ")");
                        plotPieChart($("#system-placeholder"), disks.system);
                    }

                    if (disks.user) {
                        $("#content").append(
                            "<div id='user-container' class='storage-container'> \
                                <h3 id='user-title' align='left'></h3> \
                                <div id='user-placeholder' class='storage-placeholder'></div> \
                            </div>"
                        );

                        $("#user-title").text("User (" + disks.user.mountpoint + ") (" + disks.user.total + ")");
                        plotPieChart($("#user-placeholder"), disks.user);
                    }

                    for (var i = 0; i  < disks.removable.length; i++) {
                        $("#content").append(
                            "<div id='removable-container[" + i + "]' class='storage-container'> \
                                <h3 id='removable-title[" + i + "]' align='left'></h3> \
                                <div id='removable-placeholder[" + i + "]' class='storage-placeholder'></div> \
                            </div>"
                        );

                        $("#removable-title\\[" + i + "\\]").text("Removable (" + disks.removable[i].mountpoint + ") (" + disks.removable[i].total + ")");
                        plotPieChart($("#removable-placeholder\\[" + i + "\\]"), disks.removable[i]);
                    }

                    setContentWidth();
                });

                self.storageClient.event.on("storage.localdisk#list#error", function(event, error) {});
            });

            storageViewController.event.on("core.protospec#error", function(event, error) {});

            storageViewController.initiate();
        });

        /* UI interaction handling */
        var plotPieChart = function(placeholder, disk) {
            var data = [{
                label: "Used",
                data: disk.usedPer,
                color: "#D51"
            },
            {
                label: "Available",
                data: disk.freePer,
                color: "#6B0"
            }];

            placeholder.unbind();

            $.plot(placeholder, data, {
                series: {
                    pie: {
                        show: true,
                        radius: 1,
                        label: {
                            show: true,
                            radius: 3/5,
                            formatter: function (label, series) {
                                var divStyleBegin = "<div style='text-align:center; padding:2px; color:white;'>";
                                var divStyleEnd = "</div>";
                                if (label == "Used")
                                    return divStyleBegin + disk.used + " Used<br/>" + disk.usedPer + "%" + divStyleEnd;
                                else
                                    return divStyleBegin + disk.available + " Available<br/>" + disk.freePer + "%" + divStyleEnd;
                            },
                            background: {
                                opacity: 0.5
                            }
                        }
                    }
                },
                legend: {
                    show: true
                }
            });
        };
    </script>
</head>
<body>
    <div id="wrapper">
        <div id="header"></div>
        <div id="content"></div>
        <div id="footer"></div>
    </div>

    <script>
        var page = new Page();
        page.setTitle("Storage Usage");
        page.createNavigationBar("Storage Usage");
        page.setFooterText("%COPYRIGHT%");

        var brandLabel = new NavigationBarLabel("%BRAND%");
        page.navigationBar.rightContainer.pushItem(brandLabel);
    </script>
</body>
</html>

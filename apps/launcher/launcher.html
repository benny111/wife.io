<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>

    <!-- Import JQuery library -->
    <script src="http://%SYSIP%:%SYSPORT%/lib/jquery/jquery-1.11.1.min.js"></script>

    <!-- Import Foundation Frameworks -->
    <script src="http://%SYSIP%:%SYSPORT%/lib/framework/base/base.min.js"></script>

    <!-- Import UI Frameworks -->
    <script src="http://%SYSIP%:%SYSPORT%/lib/framework/ui/bundle.js"></script>

    <!-- Import Launcher page style -->
    <link href="css/style.css" rel="stylesheet">
    <link href="css/shake.css" rel="stylesheet">

    <script>
        /* Launcher Constructor */
        function Launcher() {
            this.manageMode = false;
            this.appManagerClient = new AppManagerClient();
            this.fileManagerClient = new FileManagerClient();
        };

        /* Inherit DiligentClient */
        Launcher.prototype = new DiligentClient();
        Launcher.prototype.constructor = Launcher;

        $(function() {
            var launcher = new Launcher();

            launcher.event.on("diligent.connection#established", function(event) {
                launcher.appManagerClient.attach(launcher);
                launcher.fileManagerClient.attach(launcher);
            });

            launcher.event.on("diligent.connection#closed", function(event) {
                launcher.appManagerClient.detach();
                launcher.fileManagerClient.detach();
            });

            launcher.event.on("diligent.connection#error", function(event, error) {});

            launcher.event.on("diligent.wsapi#loaded", function(event) {
                var self = launcher;

                self.appManagerClient.event.on("app.list", function(event, arg) {
                    /* Sort app list if needed */
                    self.fileManagerClient.exist("appsort.json", function(path, exist, isDir, error) {
                        if (error) throw new Error("File system operation error");

                        if (exist) {
                            self.fileManagerClient.readFile("appsort.json", "utf8", function(path, data, error) {
                                if (error)
                                    page.notifier.add("Launcher Error", "Unable to read APP list (" + error + ")", "img/icon.png", 10000);
                                else {
                                    //try {
                                        var i;
                                        var sorted = JSON.parse(data);

                                        /* Build sorted app list directory to speed up merge process */
                                        var appDirectory = [];
                                        for (i in sorted)
                                            appDirectory[sorted[i].Directory] = sorted[i];

                                        /* Merge sorted list & latest app list */
                                        for (i in arg.list)
                                            if (appDirectory[arg.list[i].Directory] === undefined)
                                                sorted.push(arg.list[i]);

                                        self.appList = sorted;

                                        showApps(self);
                                        postConfigUI(self);
                                    //}
                                    //catch (err) {
                                    //    alert("Read appsort.json error: " + err);
                                    //}
                                }
                            });
                        }
                        else {
                            var appsort = JSON.stringify(arg.list, null, 4);
                            self.fileManagerClient.writeFile("appsort.json", appsort, function(path, progress, error) {
                                if (error)
                                    page.notifier.add("Launcher Error", "Unable to write APP list", "img/icon.png", 10000);
                            });

                            self.appList = arg.list;
                            showApps(self);
                            postConfigUI(self);
                        }
                    });
                });

                self.appManagerClient.event.on("app.uninstall#success", function(event, appInfo) {
                    /* Remove appInfo from appList */
                    for (var i = 0, len = self.appList.length; i < len; i++) {
                        if (self.appList[i].Directory === appInfo.Directory) {
                            self.appList.splice(i, 1);
                            break;
                        }
                    }

                    /* Update appsort.json */
                    var appsort = JSON.stringify(self.appList, null, 4);
                    self.fileManagerClient.writeFile("appsort.json", appsort, function(path, progress, error) {
                        if (error)
                            page.notifier.add("Launcher Error", "Unable to write APP list", "img/icon.png", 10000);
                    });

                    /* Remove app icon */
                    var elementIconLi = document.getElementById("icon-li-" + appInfo.Directory);
                    if (elementIconLi)
                        document.getElementById("applist").removeChild(elementIconLi);
                });

                self.appManagerClient.event.on("app.uninstall#error", function(event, error) {
                    page.notifier.add("Installer Error", "Unable to uninstall APP: " + error, "/apps/b/installer/img/icon.png", 10000);
                });

                self.appManagerClient.list();
            });

            launcher.event.on("diligent.wsapi#error", function(event, error) {});

            launcher.initiate();
        });

        /* UI interaction handling */
        function enterManageMode(self) {
            if (!self.manageMode) {
                self.manageMode = true;

                for (var i in self.appList) {
                    var app = self.appList[i];
                    var appType = self.appManagerClient.getType(app);

                    var elementLi = document.getElementById("icon-li-" + app.Directory);
                    var elementA = document.getElementById("icon-a-" + app.Directory);
                    var elementIconDiv = document.getElementById("icon-div-" + app.Directory);

                    if (appType === "user") {
                        elementOverlayImg = document.createElement("img");
                        elementOverlayImg.setAttribute("id", "overlay-img-" + app.Directory);
                        elementOverlayImg.setAttribute("src", "img/delete-icon.png");

                        elementOverlayDiv = document.createElement("div");
                        elementOverlayDiv.setAttribute("id", "overlay-div-" + app.Directory);
                        elementOverlayDiv.setAttribute("class", "overlay");
                        elementOverlayDiv.appendChild(elementOverlayImg);

                        elementIconDiv.appendChild(elementOverlayDiv);
                    }

                    elementA.setAttribute("href", "#");
                    if (appType === "builtin")
                        elementA.setAttribute("title", "Builtin APP");
                    else
                        elementA.setAttribute("title", "Delete " + app.AppName);

                    elementIconDiv.setAttribute("class", "shake");
                }

                $("#applist").sortable("enable");
            }
        }

        function leaveManageMode(self) {
            if (self.manageMode) {
                self.manageMode = false;

                for (var i in self.appList) {
                    var app = self.appList[i];
                    var appType = self.appManagerClient.getType(app);

                    var elementA = document.getElementById("icon-a-" + app.Directory);
                    var elementIconDiv = document.getElementById("icon-div-" + app.Directory);

                    if (appType === "user") {
                        var elementOverlayImg = document.getElementById("overlay-img-" + app.Directory);
                        var elementOverlayDiv = document.getElementById("overlay-div-" + app.Directory);

                        elementOverlayDiv.removeChild(elementOverlayImg);
                        elementIconDiv.removeChild(elementOverlayDiv);

                        elementA.setAttribute("href", "/apps/u/" + app.Directory + "/" + app.AppEntry);
                    }
                    else
                        elementA.setAttribute("href", "/apps/b/" + app.Directory + "/" + app.AppEntry);

                    elementA.setAttribute("title", app.Description);

                    elementIconDiv.removeAttribute("class");
                }

                $("#applist").sortable("disable");
            }
        }

        function showApps(self) {
            for (var i in self.appList)
                showAppAtIndex(self, self.appList[i], i);
        }

        function showAppAtIndex(self, app, index) {
            var appType = self.appManagerClient.getType(app);

            if (appType === "unknown")
                return;

            var elementIconImg = document.createElement("img");
            elementIconImg.setAttribute("id", "icon-img-" + app.Directory);
            elementIconImg.setAttribute("width", "100%");
            elementIconImg.setAttribute("height", "100%");

            var elementIconDiv = document.createElement("div");
            elementIconDiv.setAttribute("id", "icon-div-" + app.Directory);
            if (appType === "user") {
                elementIconImg.setAttribute("src", "/apps/u/" + app.Directory + "/img/icon.png");
                elementIconDiv.setAttribute(
                    "style",
                    "background:url(/apps/u/" + app.Directory + "/img/icon.png) no-repeat; background-size: contain;"
                );
            }
            else {
                elementIconImg.setAttribute("src", "/apps/b/" + app.Directory + "/img/icon.png");
                elementIconDiv.appendChild(elementIconImg);
            }

            var elementText = document.createElement("span");
            elementText.setAttribute("id", "icon-text-" + app.Directory);
            elementText.appendChild(document.createTextNode(app.AppName));

            var elementA = document.createElement("a");
            elementA.setAttribute("id", "icon-a-" + app.Directory);
            elementA.appendChild(elementIconDiv);
            if (appType === "user")
                elementA.setAttribute("href", "/apps/u/" + app.Directory + "/" + app.AppEntry);
            else
                elementA.setAttribute("href", "/apps/b/" + app.Directory + "/" + app.AppEntry);
            elementA.setAttribute("title", app.Description);
            elementA.appendChild(elementText);

            var elementLi = document.createElement("li");
            elementLi.setAttribute("id", "icon-li-" + app.Directory);
            elementLi.appendChild(elementA);
            document.getElementById("applist").appendChild(elementLi);
        }

        function postConfigUI(self) {
            $("a").mousedown(function() {
                if (!self.manageMode) {
                    var ignoreClick = true;
                }

                var longPressTimeout = setTimeout(enterManageMode, 750, self);
                $(this).mouseup(function() {
                    clearTimeout(longPressTimeout);
                    $(this).unbind("mouseup");
                    return true;
                });

                $(this).mousemove(function() {
                    clearTimeout(longPressTimeout);
                    $(this).unbind("mousemove");
                    return true;
                });

                $(this).unbind("click");
                $(this).bind("click", function() {
                    if (self.manageMode) {
                        if (!ignoreClick) {
                            var ids = $(this).attr("id").split("-");
                            for (var i = 0, len = self.appList.length; i < len; i++) {
                                if (self.appList[i].Directory === ids[2]) {
                                    if (confirm("Are you sure?"))
                                        self.appManagerClient.uninstall(self.appList[i]);
                                    break;
                                }
                            }
                        }
                        return false;
                    }
                    else
                        return true;
                });

                return true;
            });

            $("#applist").bind("click", function() {
                if (self.manageMode) {
                    leaveManageMode(self);
                    return false;
                }
                return true;
            });

            $("#applist").sortable({
                start: function(event, ui) {
                    var startPos = ui.item.index();
                    ui.item.data('start_pos', startPos);
                },
                update: function (event, ui) {
                    var startPos = ui.item.data('start_pos');
                    var endPos = ui.item.index();

                    /* Reposition app item */
                    var tmp = self.appList[startPos];
                    self.appList.splice(startPos, 1);
                    self.appList.splice(endPos, 0, tmp);
                    self.appList.join();

                    /* Update appsort.json */
                    var appsort = JSON.stringify(self.appList, null, 4);
                    self.fileManagerClient.writeFile("appsort.json", appsort, function(path, progress, error) {
                        if (error)
                            page.notifier.add("Launcher Error", "Unable to write APP list", "img/icon.png", 10000);
                    });

                }
            });
            $("#applist").sortable("disable");
            $("#applist").disableSelection();
        };
    </script>
</head>
<body>
    <div id="wrapper">
        <img class="background-image" />
        <div id="header"></div>
        <div id="content">
            <div class="apps">
                <ul id="applist"></ul>
            </div>
        </div>
        <div id="footer"></div>
    </div>

    <script>
        var page = new Page();
        page.setTitle("%SYSNAME%");
        page.createNavigationBar("%SYSNAME%");
        page.setFooterText("%COPYRIGHT%");

        var brandLabel = new NavigationBarLabel("%BRAND%");
        page.navigationBar.rightContainer.pushItem(brandLabel);
    </script>
</body>
</html>

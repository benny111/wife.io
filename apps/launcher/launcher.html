<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>

    <!-- Import JQuery library -->
    <script src="http://%SYSIP%:8001/lib/jquery/jquery-1.11.1.min.js"></script>

    <!-- Import Foundation Frameworks -->
    <script src="http://%SYSIP%:8001/lib/framework/foundation/foundation.js"></script>

    <!-- Import UI Frameworks -->
    <script src="http://%SYSIP%:8001/lib/framework/ui/ui-kits.js"></script>

    <!-- Import Launcher page style -->
    <link href="css/style.css" rel="stylesheet">
    <link href="css/shake.css" rel="stylesheet">

    <script>
        /* Launcher Constructor */
        function Launcher() {
            this._super = CoreClient;
            this.delegate = this;
            this.manageMode = false;
            this.appManagerClient = new AppManagerClient();
            this.fileManagerClient = new FileManagerClient();
        };

        /* Inherit CoreClient */
        Launcher.prototype = new CoreClient();
        Launcher.prototype.constructor = Launcher;

        extend(Launcher.prototype, AppManagerDelegate.prototype);

        /* Implement connection delegates */
        Launcher.prototype.connectionDidEstablish = function() {
            this._super.prototype.connectionDidEstablish.call(this);
            this.appManagerClient.register(this);
            this.fileManagerClient.register(this);
        };

        Launcher.prototype.connectionDidClose = function() {
            this.appManagerClient.unregister();
            this.fileManagerClient.unregister();
            this._super.prototype.connectionDidClose.call(this);
        };

        /* Implement protocol delegates */
        Launcher.prototype.protoDidLoadSpec = function() {
            this._super.prototype.protoDidLoadSpec.call(this);
            this.appManagerClient.list();
        };

        Launcher.prototype.protoDidFailLoadSpecWithError = function(error) {
            this._super.prototype.protoDidFailLoadSpecWithError.call(this);
        };

        /* Implement app manager delegates */
        Launcher.prototype.appIsUploading = function(installationCode){};
        Launcher.prototype.appIsInstalling = function(installationCode){};
        Launcher.prototype.appDidInstall = function(installationCode){};
        Launcher.prototype.appDidCancelInstall = function(installationCode){};

        Launcher.prototype.appDidUninstall = function(appInfo) {
            /* Remove appInfo from appList */
            for (var i = 0, len = this.appList.length; i < len; i++) {
                if (this.appList[i].Directory === appInfo.Directory) {
                    this.appList.splice(i, 1);
                    break;
                }
            }

            /* Update appsort.json */
            var appsort = JSON.stringify(this.appList, null, 4);
            this.fileManagerClient.writeFile("appsort.json", appsort, function(path, error) {
                if (error)
                    alert("Unable to write sorted list");
            });

            /* Remove app icon */
            var elementIconLi = document.getElementById("icon-li-" + appInfo.Directory);
            if (elementIconLi)
                document.getElementById("applist").removeChild(elementIconLi);
        };

        Launcher.prototype.appDidFailInstallWithError = function(error){};

        Launcher.prototype.appDidFailUninstallWithError = function(error) {
            alert(error);
        };

        Launcher.prototype.appListDidLoad = function(appList) {
            var self = this;

            /* Sort app list if needed */
            self.fileManagerClient.exist("appsort.json", function(path, exist, isDir, error) {
                if (error) throw new Error("File system operation error");

                if (exist) {
                    self.fileManagerClient.readFile("appsort.json", "utf8", function(path, data, error) {
                        if (error)
                            alert("Unable to read sorted list");
                        else {
                            try {
                                var i;
                                var sorted = JSON.parse(data);

                                /* Build sorted app list directory to speed up merge process */
                                var appDirectory = [];
                                for (i in sorted)
                                    appDirectory[sorted[i].Directory] = sorted[i];

                                /* Merge sorted list & latest app list */
                                for (i in appList)
                                    if (appDirectory[appList[i].Directory] === undefined)
                                        sorted.push(appList[i]);

                                self.appList = sorted;

                                showApps(self);
                                postConfigUI(self);
                            }
                            catch (err) {
                                alert(err);
                            }
                        }
                    });
                }
                else {
                    var appsort = JSON.stringify(appList, null, 4);
                    self.fileManagerClient.writeFile("appsort.json", appsort, function(path, error) {
                        if (error)
                            alert("Unable to write sorted list");
                    });

                    self.appList = appList;
                    showApps(self);
                    postConfigUI(self);
                }
            });
        };

        $(function() {
            var launcher = new Launcher();
            launcher.initiate();
        });

        /* UI interaction handling */
        function enterManageMode(self) {
            if (!self.manageMode) {
                self.manageMode = true;

                for (var i in self.appList) {
                    var app = self.appList[i];
                    var appType = self.appManagerClient.getType(app);

                    var elementLi = document.getElementById("icon-li-" + app.Directory);
                    var elementA = document.getElementById("icon-a-" + app.Directory);
                    var elementIconDiv = document.getElementById("icon-div-" + app.Directory);

                    if (appType === "user") {
                        elementOverlayImg = document.createElement("img");
                        elementOverlayImg.setAttribute("id", "overlay-img-" + app.Directory);
                        elementOverlayImg.setAttribute("src", "img/delete-icon.png");
                        elementOverlayImg.setAttribute("width", "50%");
                        elementOverlayImg.setAttribute("height", "50%");

                        elementOverlaySpan = document.createElement("span");
                        elementOverlaySpan.setAttribute("id", "overlay-span-" + app.Directory);
                        elementOverlaySpan.setAttribute("class", "delete");
                        elementOverlaySpan.appendChild(elementOverlayImg);

                        elementOverlayDiv = document.createElement("div");
                        elementOverlayDiv.setAttribute("id", "overlay-div-" + app.Directory);
                        elementOverlayDiv.setAttribute("class", "overlay");
                        elementOverlayDiv.appendChild(elementOverlaySpan);

                        elementIconDiv.appendChild(elementOverlayDiv);
                    }

                    elementA.setAttribute("href", "#");
                    if (appType === "builtin")
                        elementA.setAttribute("title", "Builtin APP");
                    else
                        elementA.setAttribute("title", "Delete " + app.AppName);

                    elementIconDiv.setAttribute("class", "shake");
                }

                $("#applist").sortable("enable");
            }
        }

        function leaveManageMode(self) {
            if (self.manageMode) {
                self.manageMode = false;

                for (var i in self.appList) {
                    var app = self.appList[i];
                    var appType = self.appManagerClient.getType(app);

                    var elementA = document.getElementById("icon-a-" + app.Directory);
                    var elementIconDiv = document.getElementById("icon-div-" + app.Directory);

                    if (appType === "user") {
                        var elementOverlayImg = document.getElementById("overlay-img-" + app.Directory);
                        var elementOverlaySpan = document.getElementById("overlay-span-" + app.Directory);
                        var elementOverlayDiv = document.getElementById("overlay-div-" + app.Directory);

                        elementOverlaySpan.removeChild(elementOverlayImg);
                        elementOverlayDiv.removeChild(elementOverlaySpan);
                        elementIconDiv.removeChild(elementOverlayDiv);
                    }

                    elementA.setAttribute("href", "../" + app.Directory + "/" + app.AppEntry);
                    elementA.setAttribute("title", app.Description);

                    elementIconDiv.removeAttribute("class");
                }

                $("#applist").sortable("disable");
            }
        }

        function showApps(self) {
            for (var i in self.appList)
                showAppAtIndex(self, self.appList[i], i);
        }

        function showAppAtIndex(self, app, index) {
            var appType = self.appManagerClient.getType(app);

            if (appType === "unknown")
                return;

            elementIconImg = document.createElement("img");
            elementIconImg.setAttribute("id", "icon-img-" + app.Directory);
            elementIconImg.setAttribute("src", "../" + app.Directory + "/img/icon.png");
            elementIconImg.setAttribute("width", "100%");
            elementIconImg.setAttribute("height", "100%");

            elementIconDiv = document.createElement("div");
            elementIconDiv.setAttribute("id", "icon-div-" + app.Directory);
            if (appType === "user")
                elementIconDiv.setAttribute(
                    "style",
                    "background:url(../" + app.Directory + "/img/icon.png) no-repeat; background-size: contain;"
                );
            else
                elementIconDiv.appendChild(elementIconImg);

            elementA = document.createElement("a");
            elementA.setAttribute("id", "icon-a-" + app.Directory);
            elementA.appendChild(elementIconDiv);
            elementA.appendChild(document.createTextNode(app.AppName));
            elementA.setAttribute("href", "../" + app.Directory + "/" + app.AppEntry);
            elementA.setAttribute("title", app.Description);

            elementLi = document.createElement("li");
            elementLi.setAttribute("id", "icon-li-" + app.Directory);
            elementLi.appendChild(elementA);
            document.getElementById("applist").appendChild(elementLi);
        }

        function postConfigUI(self) {
            $("a").mousedown(function() {
                if (!self.manageMode) {
                    var ignoreClick = true;
                }

                var longPressTimeout = setTimeout(enterManageMode, 750, self);
                $(this).mouseup(function() {
                    clearTimeout(longPressTimeout);
                    $(this).unbind("mouseup");
                    return true;
                });

                $(this).mousemove(function() {
                    clearTimeout(longPressTimeout);
                    $(this).unbind("mousemove");
                    return true;
                });

                $(this).unbind("click");
                $(this).bind("click", function() {
                    if (self.manageMode) {
                        if (!ignoreClick) {
                            var ids = $(this).attr("id").split("-");
                            for (var i = 0, len = self.appList.length; i < len; i++) {
                                if (self.appList[i].Directory === ids[2]) {
                                    if (confirm("Are you sure?"))
                                        self.appManagerClient.uninstall(self.appList[i]);
                                    break;
                                }
                            }
                        }
                        return false;
                    }
                    else
                        return true;
                });

                return true;
            });

            $("#applist").bind("click", function() {
                if (self.manageMode) {
                    leaveManageMode(self);
                    return false;
                }
                return true;
            });

            $("#applist").sortable({
                start: function(event, ui) {
                    var startPos = ui.item.index();
                    ui.item.data('start_pos', startPos);
                },
                update: function (event, ui) {
                    var startPos = ui.item.data('start_pos');
                    var endPos = ui.item.index();

                    /* Reposition app item */
                    var tmp = self.appList[startPos];
                    self.appList.splice(startPos, 1);
                    self.appList.splice(endPos, 0, tmp);
                    self.appList.join();

                    /* Update appsort.json */
                    var appsort = JSON.stringify(self.appList, null, 4);
                    self.fileManagerClient.writeFile("appsort.json", appsort, function(path, error) {
                        if (error)
                            alert("Unable to write sorted list");
                    });

                }
            });
            $("#applist").sortable("disable");
            $("#applist").disableSelection();
        };
    </script>
</head>
<body>
    <div id="wrapper">
        <div id="header"></div>
        <div id="content">
            <div class="apps">
                <ul id="applist">
    <!--
                    <li><a href="#"><i class="fa fa-facebook-square fa-4x"></i>Facebook</a></li>
                    <li><a href="#"><i class="fa fa-twitter-square fa-4x"></i>Twitter</a></li>
                    <li><a href="#"><i class="fa fa-youtube-square fa-4x"></i>Youtube</a></li>
                    <li><a href="#"><i class="fa fa-skype fa-4x"></i>Skype</a></li>
                    <li><a href="#"><i class="fa fa-windows fa-4x"></i>Windows</a></li>
                    <li><a href="#"><i class="fa fa-linkedin fa-4x"></i>Linkedin</a></li>
                    <li><a href="#"><i class="fa fa-apple fa-4x"></i>Apple</a></li>
                    <li><a href="#"><i class="fa fa-android fa-4x"></i>Android</a></li>
                    <li><a href="#"><i class="fa fa-dribbble fa-4x"></i>Dribbble</a></li>
                    <li><a href="#"><i class="fa fa-html5 fa-4x"></i>HTML5</a></li>
                    <li><a href="#"><i class="fa fa-linux fa-4x"></i>Linux</a></li>
                    <li><a href="#"><i class="fa fa-css3 fa-4x"></i>CSS3</a></li>
                    <li><a href="#"><i class="fa fa-github fa-4x"></i>Github</a></li>
                    <li><a href="#"><i class="fa fa-pinterest fa-4x"></i>Pinterest</a></li>
                    <li><a href="#"><i class="fa fa-tumblr-square fa-4x"></i>Tumblr</a></li>
                    <li><a href="#"><i class="fa fa-dropbox fa-4x"></i>Dropbox</a></li>
                    <li><a href="#"><i class="fa fa-instagram fa-4x"></i>Instagram</a></li>
    -->
                </ul>
            </div>
        </div>
        <div id="footer"></div>
    </div>

    <script>
        var page = new Page();
        page.setTitle("%SYSNAME% Launcher");
        page.createNavigationBar("%SYSNAME% Launcher");
        page.setFooterText("%COPYRIGHT%");

        var brandLabel = new NavigationBarLabel("%BRAND%");
        page.navigationBar.rightContainer.pushItem(brandLabel);
    </script>
</body>
</html>

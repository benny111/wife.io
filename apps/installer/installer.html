<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title></title>

    <!-- Import Socket.IO client library -->
    <script src="http://%SYSIP%:8001/socket.io/socket.io.js"></script>

    <!-- Import Socket.IO-stream library for file transfer support -->
    <script src="js/socket.io-stream.js"></script>

    <!-- Import JQuery library -->
    <link rel="stylesheet" href="http://%SYSIP%:8001/lib/jquery/ui/1.11.1/themes/ui-lightness/jquery-ui.min.css">
    <script src="http://%SYSIP%:8001/lib/jquery/jquery-1.11.1.min.js"></script>
    <script src="http://%SYSIP%:8001/lib/jquery/ui/1.11.1/jquery-ui.min.js"></script>

    <!-- Import Foundation Frameworks -->
    <script src="http://%SYSIP%:8001/lib/framework/foundation/core-client.js"></script>
    <script src="http://%SYSIP%:8001/lib/framework/foundation/core-client-delegate.js"></script>

    <!-- Import UI Frameworks -->
    <link rel="stylesheet" href="http://%SYSIP%:8001/lib/framework/ui/page/css/page.css">
    <script src="http://%SYSIP%:8001/lib/framework/ui/page/js/page.js"></script>
    <link rel="stylesheet" href="http://%SYSIP%:8001/lib/framework/ui/navigation-bar/css/navigation-bar.css">
    <script src="http://%SYSIP%:8001/lib/framework/ui/navigation-bar/js/navigation-bar.js"></script>
    <link rel="stylesheet" href="http://%SYSIP%:8001/lib/framework/ui/progress-dialog/css/progress-dialog.css">
    <script src="http://%SYSIP%:8001/lib/framework/ui/progress-dialog/js/progress-dialog.js"></script>

    <!-- Import installer style -->
    <link rel="stylesheet" href="css/style.css">

    <script>
        var closeUpload = function() {
            progressDialog.close();
            progressDialog.setProgress(false);
            $("#uploadButton").button().focus();
        }

        /* InstallerDelegate Constructor */
        var InstallerDelegate = function() {};

        /* Create installer delegate and inherit CoreClientDelegate */
        InstallerDelegate.prototype = new CoreClientDelegate;
        InstallerDelegate.prototype.constructor = InstallerDelegate;

        /* Implement connection delegates */
        InstallerDelegate.prototype.connectionEstablished = function(coreClient) {
            //alert("Socket.IO connection established");

            progressDialog.onProgressEvent({
                change: function() {
                    progressDialog.setMessage("Uploading APP: " + progressDialog.progress() + "%");
                },
                complete: function() {
                    progressDialog.setMessage("Prepare to install ...");
                }
            });

            progressDialog.onDialogEvent({
                open: function() {},
                close: function() {},
                beforeClose: function() {
                    $("#uploadButton").button().button("option", {
                        disabled: false,
                        label: "Start Upload"
                    });
                }
            });

            $("#uploadButton").button().on("click", function() {
                $(this).button("option", {
                    disabled: true,
                    label: "Uploading..."
                });

                progressDialog.setButton("Cancel", function() {
                    var appBundle = $("#uploadAppBundle")[0].files[0];
                    coreClient.appCancelInstall(appBundle);
                });

                var appBundle = $("#uploadAppBundle")[0].files[0];
                var size = 0;

                // Upload appBundle to the server.
                coreClient.appInstall(ss, appBundle, function(chunk) {
                    size += chunk.length;
                    progressDialog.setProgress(Math.floor(size / appBundle.size * 100));
                });

                progressDialog.open();
            });
        };

        InstallerDelegate.prototype.connectionClosed = function(coreClient) {
            //alert("Socket.IO connection closed");
        };

        InstallerDelegate.prototype.connectionFailWithError = function(coreClient, error) {
            alert("Socket.IO connection error: " + error.toString());
        };

        /* Implement protocol delegates */
        InstallerDelegate.prototype.protoErrorProtoLoad = function(coreClient, error) {
            alert("Protocol error: " + error);
        };

        InstallerDelegate.prototype.protoResponseAppInstalling = function(coreClient, appBundle) {
            progressDialog.setMessage("Installing " + appBundle.name);
            progressDialog.setButton("Please wait", function(){});
            progressDialog.setButtonEnable(false);
        };

        InstallerDelegate.prototype.protoResponseAppInstalled = function(coreClient, appBundle) {
            progressDialog.setMessage(appBundle.name + " Installed!");
            progressDialog.setButton("Close", closeUpload);
            progressDialog.setButtonEnable(true);
            progressDialog.setButtonFocus(true);
        };

        InstallerDelegate.prototype.protoResponseAppInstallCancelled = function(coreClient, appBundle) {
            progressDialog.setMessage(appBundle.name + " installation cancelled!");
            progressDialog.setButton("Close", closeUpload);
            progressDialog.setButtonEnable(true);
            progressDialog.setButtonFocus(true);
        };

        InstallerDelegate.prototype.protoErrorAppInstall = function(coreClient, error) {
            progressDialog.setMessage("Unable to install APP (Error: " + error + ")");
            progressDialog.setButton("Close", closeUpload);
            progressDialog.setButtonEnable(true);
            progressDialog.setButtonFocus(true);
        };

        $(function() {
            var coreClient = new CoreClient();
            coreClient.delegate = new InstallerDelegate();
            coreClient.initiate();
        });
    </script>
</head>
<body>
    <div id="wrapper">
        <div id="header"></div>
        <div id="content">
            <div id="dialog"></div>
            <input type="file" id="uploadAppBundle" />
            <button id="uploadButton">Start Upload</button>
        </div>
        <div id="footer"></div>
    </div>

    <script>
        var page = new Page();
        page.setTitle("APP Installer");
        page.createNavigationBar("APP Installer");
        page.setFooterText("%COPYRIGHT%");

        var brandLabel = new NavigationBarLabel("%BRAND%");
        page.navigationBar.rightContainer.pushItem(brandLabel);

        var progressDialog = new ProgressDialog();
        progressDialog.setTitle("APP Installer");
    </script>
</body>
</html>

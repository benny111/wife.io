<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>

    <!-- Import JQuery library -->
    <script src="http://%SYSIP%:8001/lib/jquery/jquery-1.11.1.min.js"></script>

    <!-- Import Foundation Frameworks -->
    <script src="http://%SYSIP%:8001/lib/framework/foundation/foundation.js"></script>

    <!-- Import UI Frameworks -->
    <script src="http://%SYSIP%:8001/lib/framework/ui/ui-kits.js"></script>

    <!-- Import installer style -->
    <link rel="stylesheet" href="css/style.css">

    <script>
        var closeUpload = function() {
            progressDialog.hide();
            progressDialog.setProgress(false);
            $("#uploadButton").button().focus();
        }

        /* Installer Constructor */
        function Installer() {
            this._super = CoreClient;
            this.delegate = this;
            this.appInstalling = { bundle: null, code: null };
            this.appManagerClient = new AppManagerClient();
        };

        /* Inherit CoreClient */
        Installer.prototype = new CoreClient();
        Installer.prototype.constructor = Installer;

        extend(Installer.prototype, AppManagerDelegate.prototype);

        /* Implement connection delegates */
        Installer.prototype.connectionDidEstablish = function() {
            var self = this;
            this._super.prototype.connectionDidEstablish.call(this);
            this.appManagerClient.register(this);

            progressDialog.onProgressEvent({
                change: function() {
                    progressDialog.setMessage("Uploading APP: " + progressDialog.progress() + "%");
                },
                complete: function() {
                    progressDialog.setMessage("Prepare to install ...");
                }
            });

            progressDialog.onDialogEvent({
                open: function() {},
                close: function() {},
                beforeClose: function() {
                    $("#uploadButton").button().button("option", {
                        disabled: false,
                        label: "Start Upload"
                    });
                }
            });

            $("#uploadButton").button().on("click", function() {
                $(this).button("option", {
                    disabled: true,
                    label: "Uploading..."
                });

                progressDialog.setButton("Cancel", function() {
                    var appBundle = $("#uploadAppBundle")[0].files[0];
                    self.appManagerClient.cancelInstall(self.appInstalling.code);
                });

                var appBundle = $("#uploadAppBundle")[0].files[0];
                var size = 0;

                self.appInstalling.bundle = appBundle;

                // Upload appBundle to the server.
                self.appManagerClient.install(appBundle, function(chunk) {
                    size += chunk.length;
                    progressDialog.setProgress(Math.floor(size / appBundle.size * 100));
                });

                progressDialog.show();
            });
        };

        Installer.prototype.connectionDidClose = function() {
            this.appManagerClient.unregister();
            this._super.prototype.connectionDidClose.call(this);
        };

        /* Implement protocol delegates */
        Installer.prototype.protoDidLoadSpec = function() {
            this._super.prototype.protoDidLoadSpec.call(this);
        };

        Installer.prototype.protoDidFailLoadSpecWithError = function(error) {
            this._super.prototype.protoDidFailLoadSpecWithError.call(this);
        };

        /* Implement app manager delegates */
        Installer.prototype.appIsUploading = function(installationCode) {
            this.appInstalling.code = installationCode;
        };

        Installer.prototype.appIsInstalling = function(installationCode) {
            progressDialog.setMessage("Installing " + this.appInstalling.bundle.name);
            progressDialog.setButton("Please wait", function(){});
            progressDialog.setButtonEnable(false);
        };

        Installer.prototype.appDidInstall = function(installationCode) {
            if (this.appInstalling.code === installationCode) {
                progressDialog.setMessage(this.appInstalling.bundle.name + " Installed!");
                progressDialog.setButton("Close", closeUpload);
                progressDialog.setButtonEnable(true);
                progressDialog.setButtonFocus(true);
                this.appInstalling = { bundle: null, code: null };
            }
        };

        Installer.prototype.appDidCancelInstall = function(installationCode) {
            if (this.appInstalling.code === installationCode) {
                progressDialog.setMessage(this.appInstalling.bundle.name + " installation cancelled!");
                progressDialog.setButton("Close", closeUpload);
                progressDialog.setButtonEnable(true);
                progressDialog.setButtonFocus(true);
                this.appInstalling = { bundle: null, code: null };
            }
        };

        Installer.prototype.appDidFailInstallWithError = function(error) {
            if (this.appInstalling.code) {
                progressDialog.setMessage("Unable to install " + this.appInstalling.bundle.name + " (Error: " + error + ")");
                progressDialog.setButton("Close", closeUpload);
                progressDialog.setButtonEnable(true);
                progressDialog.setButtonFocus(true);
            }
        };

        Installer.prototype.appDidFailCancelInstallWithError = function(error) {
            if (this.appInstalling.code) {
                progressDialog.setMessage("Unable to cancel install " + this.appInstalling.bundle.name + " (Error: " + error + ")");
                progressDialog.setButton("Close", closeUpload);
                progressDialog.setButtonEnable(true);
                progressDialog.setButtonFocus(true);
            }
        }

        $(function() {
            var installer = new Installer();
            installer.initiate();
        });
    </script>
</head>
<body>
    <div id="wrapper">
        <div id="header"></div>
        <div id="content">
            <div id="dialog"></div>
            <input type="file" id="uploadAppBundle" />
            <button id="uploadButton">Start Upload</button>
        </div>
        <div id="footer"></div>
    </div>

    <script>
        var page = new Page();
        page.setTitle("APP Installer");
        page.createNavigationBar("APP Installer");
        page.setFooterText("%COPYRIGHT%");

        var brandLabel = new NavigationBarLabel("%BRAND%");
        page.navigationBar.rightContainer.pushItem(brandLabel);

        var progressDialog = new ProgressDialog();
        progressDialog.setTitle("APP Installer");
    </script>
</body>
</html>

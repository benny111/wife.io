<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>

    <!-- Import JQuery library -->
    <script src="http://%SYSIP%:8001/lib/jquery/jquery-1.11.1.min.js"></script>

    <!-- Import Foundation Frameworks -->
    <script src="http://%SYSIP%:8001/lib/framework/foundation/foundation.js"></script>

    <!-- Import UI Frameworks -->
    <script src="http://%SYSIP%:8001/lib/framework/ui/ui-kits.js"></script>

    <!-- Import installer style -->
    <link rel="stylesheet" href="css/style.css">

    <script>
        var closeUpload = function() {
            progressDialog.close();
            progressDialog.setProgress(false);
            $("#uploadButton").button().focus();
        }

        /* Installer Constructor */
        function Installer() {
            this._super = CoreClient;
            this.appInstalling = { bundle: null, code: null };
            this.appManagerClient = new AppManagerClient();
        };

        /* Inherit CoreClient */
        Installer.prototype = new CoreClient();
        Installer.prototype.constructor = Installer;

        $(function() {
            var installer = new Installer();

            installer.event.on("core.connection#established", function(event) {
                var self = installer;
                self.appManagerClient.attach(self);

                progressDialog.onProgressEvent({
                    change: function() {
                        progressDialog.setMessage("Uploading APP: " + progressDialog.progress() + "%");
                    },
                    complete: function() {
                        progressDialog.setMessage("Prepare to install ...");
                    }
                });

                progressDialog.onDialogEvent({
                    open: function() {},
                    close: function() {},
                    beforeClose: function() {
                        $("#uploadButton").button().button("option", {
                            disabled: false,
                            label: "Start Upload"
                        });
                    }
                });

                $("#uploadButton").button().on("click", function() {
                    $(this).button("option", {
                        disabled: true,
                        label: "Uploading..."
                    });

                    progressDialog.setButton([{
                        text: "Cancel",
                        click: function() {
                            var appBundle = $("#app-bundle-to-upload")[0].files[0];
                            self.appManagerClient.cancelInstall(self.appInstalling.code);
                        }
                    }]);

                    var appBundle = $("#app-bundle-to-upload")[0].files[0];
                    var size = 0;

                    self.appInstalling.bundle = appBundle;

                    // Upload appBundle to the server.
                    self.appManagerClient.install(appBundle, function(chunk) {
                        size += chunk.length;
                        progressDialog.setProgress(Math.floor(size / appBundle.size * 100));
                    });

                    progressDialog.open();
                });
            });

            installer.event.on("core.connection#closed", function(event) {
                installer.appManagerClient.detach();
            });

            installer.event.on("core.connection#error", function(event, error) {});

            installer.event.on("core.protospec#loaded", function(event) {
                var self = installer;

                self.appManagerClient.event.on("app.install#uploading", function(event, installationCode) {
                    self.appInstalling.code = installationCode;
                });

                self.appManagerClient.event.on("app.install#installing", function(event, installationCode) {
                    progressDialog.setMessage("Installing " + self.appInstalling.bundle.name);
                    progressDialog.setButton([{
                        text: "Please wait",
                        click: function() {}
                    }]);
                    progressDialog.setButtonEnable(0, false);
                });

                self.appManagerClient.event.on("app.install#success", function(event, installationCode) {
                    if (self.appInstalling.code === installationCode) {
                        progressDialog.setMessage(self.appInstalling.bundle.name + " Installed!");
                        progressDialog.setButton([{
                            text: "Close",
                            click: closeUpload
                        }]);
                        progressDialog.setButtonEnable(0, true);
                        progressDialog.setButtonFocus(0, true);
                        self.appInstalling = { bundle: null, code: null };
                    }
                });

                self.appManagerClient.event.on("app.install#cancelled", function(event, installationCode) {
                    if (self.appInstalling.code === installationCode) {
                        progressDialog.setMessage(self.appInstalling.bundle.name + " installation cancelled!");
                        progressDialog.setButton([{
                            text: "Close",
                            click: closeUpload
                        }]);
                        progressDialog.setButtonEnable(0, true);
                        progressDialog.setButtonFocus(0, true);
                        self.appInstalling = { bundle: null, code: null };
                    }
                });

                self.appManagerClient.event.on("app.install#error", function(event, error) {
                    if (self.appInstalling.code) {
                        progressDialog.setMessage("Unable to install " + self.appInstalling.bundle.name + " (Error: " + error + ")");
                        progressDialog.setButton([{
                            text: "Close",
                            click: closeUpload
                        }]);
                        progressDialog.setButtonEnable(0, true);
                        progressDialog.setButtonFocus(0, true);
                    }
                });

                self.appManagerClient.event.on("app.install#cancel-error", function(event, error) {
                    if (self.appInstalling.code) {
                        progressDialog.setMessage("Unable to cancel install " + self.appInstalling.bundle.name + " (Error: " + error + ")");
                        progressDialog.setButton([{
                            text: "Close",
                            click: closeUpload
                        }]);
                        progressDialog.setButtonEnable(0, true);
                        progressDialog.setButtonFocus(0, true);
                    }
                });
            });

            installer.event.on("core.protospec#error", function(event, error) {});

            installer.initiate();
        });
    </script>
</head>
<body>
    <div id="wrapper">
        <img class="background-image" />
        <div id="header"></div>
        <div id="content">
            <div id="progress-dialog"></div>
            <input type="file" id="app-bundle-to-upload" />
            <button id="uploadButton">Start Upload</button>
        </div>
        <div id="footer"></div>
    </div>

    <script>
        var page = new Page();
        page.setTitle("APP Installer");
        page.createNavigationBar("APP Installer");
        page.setFooterText("%COPYRIGHT%");

        var brandLabel = new NavigationBarLabel("%BRAND%");
        page.navigationBar.rightContainer.pushItem(brandLabel);

        var progressDialog = new Dialog("progress-dialog", "progress");
        progressDialog.setTitle("APP Installer");
    </script>
</body>
</html>

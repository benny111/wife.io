<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>

    <!-- Import JQuery library -->
    <script src="http://%SYSIP%:8001/lib/jquery/jquery-1.11.1.min.js"></script>

    <!-- Import Foundation Frameworks -->
    <script src="http://%SYSIP%:8001/lib/framework/foundation/foundation.js"></script>

    <!-- Import UI Frameworks -->
    <script src="http://%SYSIP%:8001/lib/framework/ui/ui-kits.js"></script>

    <!-- Import installer style -->
    <link rel="stylesheet" href="css/style.css">

    <script>
        var closeUpload = function() {
            progressDialog.close();
            progressDialog.setProgress(false);
            $("#uploadButton").button().focus();
        }

        /* InstallerDelegate Constructor */
        function InstallerDelegate() {
            this.appInstalling = { bundle: null, code: null };
        };

        /* Create installer delegate and inherit CoreClientDelegate */
        InstallerDelegate.prototype = new CoreClientDelegate();
        InstallerDelegate.prototype.constructor = InstallerDelegate;

        /* Implement connection delegates */
        InstallerDelegate.prototype.connectionEstablished = function(coreClient) {
            var self = this;

            //alert("Socket.IO connection established");

            progressDialog.onProgressEvent({
                change: function() {
                    progressDialog.setMessage("Uploading APP: " + progressDialog.progress() + "%");
                },
                complete: function() {
                    progressDialog.setMessage("Prepare to install ...");
                }
            });

            progressDialog.onDialogEvent({
                open: function() {},
                close: function() {},
                beforeClose: function() {
                    $("#uploadButton").button().button("option", {
                        disabled: false,
                        label: "Start Upload"
                    });
                }
            });

            $("#uploadButton").button().on("click", function() {
                $(this).button("option", {
                    disabled: true,
                    label: "Uploading..."
                });

                progressDialog.setButton("Cancel", function() {
                    var appBundle = $("#uploadAppBundle")[0].files[0];
                    coreClient.appCancelInstall(self.appInstalling.code);
                });

                var appBundle = $("#uploadAppBundle")[0].files[0];
                var size = 0;

                self.appInstalling.bundle = appBundle;

                // Upload appBundle to the server.
                coreClient.appInstall(ss, appBundle, function(chunk) {
                    size += chunk.length;
                    progressDialog.setProgress(Math.floor(size / appBundle.size * 100));
                });

                progressDialog.open();
            });
        };

        InstallerDelegate.prototype.connectionClosed = function(coreClient) {
            //alert("Socket.IO connection closed");
        };

        InstallerDelegate.prototype.connectionFailWithError = function(coreClient, error) {
            alert("Socket.IO connection error: " + error);
        };

        /* Implement protocol delegates */
        InstallerDelegate.prototype.protoErrorProtoLoad = function(coreClient, error) {
            alert("Protocol error: " + error);
        };

        InstallerDelegate.prototype.protoResponseAppUploading = function(coreClient, installationCode) {
            this.appInstalling.code = installationCode;
        };

        InstallerDelegate.prototype.protoResponseAppInstalling = function(coreClient, installationCode) {
            progressDialog.setMessage("Installing " + this.appInstalling.bundle.name);
            progressDialog.setButton("Please wait", function(){});
            progressDialog.setButtonEnable(false);
        };

        InstallerDelegate.prototype.protoResponseAppInstalled = function(coreClient, installationCode) {
            if (this.appInstalling.code === installationCode) {
                progressDialog.setMessage(this.appInstalling.bundle.name + " Installed!");
                progressDialog.setButton("Close", closeUpload);
                progressDialog.setButtonEnable(true);
                progressDialog.setButtonFocus(true);
                this.appInstalling = { bundle: null, code: null };
            }
        };

        InstallerDelegate.prototype.protoResponseAppInstallCancelled = function(coreClient, installationCode) {
            if (this.appInstalling.code === installationCode) {
                progressDialog.setMessage(this.appInstalling.bundle.name + " installation cancelled!");
                progressDialog.setButton("Close", closeUpload);
                progressDialog.setButtonEnable(true);
                progressDialog.setButtonFocus(true);
                this.appInstalling = { bundle: null, code: null };
            }
        };

        InstallerDelegate.prototype.protoErrorAppInstall = function(coreClient, error) {
            if (this.appInstalling.code) {
                progressDialog.setMessage("Unable to install " + this.appInstalling.bundle.name + " (Error: " + error + ")");
                progressDialog.setButton("Close", closeUpload);
                progressDialog.setButtonEnable(true);
                progressDialog.setButtonFocus(true);
            }
        };

        $(function() {
            var coreClient = new CoreClient();
            coreClient.delegate = new InstallerDelegate();
            coreClient.initiate();
        });
    </script>
</head>
<body>
    <div id="wrapper">
        <div id="header"></div>
        <div id="content">
            <div id="dialog"></div>
            <input type="file" id="uploadAppBundle" />
            <button id="uploadButton">Start Upload</button>
        </div>
        <div id="footer"></div>
    </div>

    <script>
        var page = new Page();
        page.setTitle("APP Installer");
        page.createNavigationBar("APP Installer");
        page.setFooterText("%COPYRIGHT%");

        var brandLabel = new NavigationBarLabel("%BRAND%");
        page.navigationBar.rightContainer.pushItem(brandLabel);

        var progressDialog = new ProgressDialog();
        progressDialog.setTitle("APP Installer");
    </script>
</body>
</html>

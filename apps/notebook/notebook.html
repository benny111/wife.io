<!DOCTYPE html>
<!--[if lt IE 7]> <html class="lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>    <html class="lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>    <html class="lt-ie9"> <![endif]-->
<!--[if IE 9]>    <html class="ie9"> <![endif]-->
<!--[if gt IE 9]><!--> <html> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title></title>

        <!-- Import JQuery library -->
        <script src="http://%SYSIP%:8001/lib/jquery/jquery-1.11.1.min.js"></script>

        <!-- Import Foundation Frameworks -->
        <script src="http://%SYSIP%:8001/lib/framework/foundation/foundation.js"></script>

        <!-- Import UI Frameworks -->
        <script src="http://%SYSIP%:8001/lib/framework/ui/ui-kits.js"></script>

        <!-- Import Font Awesome -->
        <link href="http://%SYSIP%:8001/lib/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

        <!-- Import 3rd party frameworks -->
        <script src="lib/ckeditor/ckeditor.js"></script>
        <script src="lib/jqTree/tree.jquery.js"></script>

        <!-- Import note style -->
        <link href="lib/jqTree/jqtree.css" rel="stylesheet">
        <link href="css/main.css" rel="stylesheet">
        <link href="css/text-input-dialog.css" rel="stylesheet">
        <link href="css/bookshelf.css" rel="stylesheet">
        <link href="css/notebook.css" rel="stylesheet">
        <link href="css/note-editor.css" rel="stylesheet">

        <!-- Import bookshelf -->
        <script src="js/text-input-dialog.js"></script>
        <script src="js/bookshelf.js"></script>
        <script src="js/notebook.js"></script>
        <script src="js/note-editor.js"></script>

        <script>
            var bookshelf;
            var notebook;
            var noteEditor;

            /* NotebookViewController Constructor */
            function NotebookViewController() {
                this._super = CoreClient;
                this.fileManagerClient = new FileManagerClient();
            };

            /* Inherit CoreClient */
            NotebookViewController.prototype = new CoreClient();
            NotebookViewController.prototype.constructor = NotebookViewController;

            $(function() {
                var notebookViewController = new NotebookViewController();

                notebookViewController.event.on("core.connection#established", function(event) {
                    notebookViewController.fileManagerClient.attach(notebookViewController);
                });

                notebookViewController.event.on("core.connection#closed", function(event) {
                    notebookViewController.fileManagerClient.detach();
                });

                notebookViewController.event.on("core.connection#error", function(event, error) {});

                notebookViewController.event.on("core.protospec#loaded", function(event) {
                    /* Initialize bookshelf and load notebooks */
                    bookshelf = new Bookshelf(notebookViewController.fileManagerClient);
                    notebook = new Notebook(notebookViewController.fileManagerClient);
                    noteEditor = new NoteEditor(notebookViewController.fileManagerClient);

                    /* bookshelf event handling */
                    bookshelf.jqueryElement.on("bookshelf.loaded", function(event, arg) {
                        //arg.treeData;
                    });

                    bookshelf.jqueryElement.on("bookshelf.select", function(event, arg) {
                        if (arg.node)
                            notebook.open(arg.node);
                        else
                            notebook.close();

                        if (bookshelf.selectedNode && bookshelf.selectedNode.isFolder())
                            $("#add-note-button").attr("disabled", true);
                        else
                            $("#add-note-button").attr("disabled", false);
                    });

                    bookshelf.jqueryElement.on("bookshelf.update", function(event, arg) {
                        if (arg.node === notebook.notebookNode) {
                            setTimeout(function() { notebook.updateTitleBar(); }, 500);
                        }
                    });

                    /* Notebook list event handling */
                    notebook.jqueryElement.on("notebook.select", function(event, arg) {
                        noteEditor.loadContent(arg.path, arg.index);
                    });

                    notebook.jqueryElement.on("notebook.deselect", function(event, arg) {
                        noteEditor.clearContent();
                    });

                    /* Note editor event handling */
                    noteEditor.jqueryElement.on("note-editor.ready", function(event, arg) {
                        /* Resize editor after loaded */
                        setContentSizeFit();
                        /* Select first stack or notebook by default */
                        bookshelf.selectNotebookAtIndex(0);
                    });

                    noteEditor.jqueryElement.on("note-editor.save", function(event, index) {
                        $("#status-msg").text("Saved!");
                        $("#status-msg").fadeIn(500);
                        $("#status-msg").fadeOut(2000, function() {});
                        notebook.reloadNote(index);
                    });
                });

                notebookViewController.event.on("core.protospec#error", function(event, error) {});

                notebookViewController.initiate();
                setContentSizeFit();
            });

            $(window).resize(function() {
                setContentSizeFit();
            });
        </script>
    </head>
    <body>
        <div id="wrapper">
            <div id="header"></div>
            <div id="content">
                <div id="bar-container">
                    <div id="toolbar" class="ui-toolbar ui-widget-header ui-helper-clearfix">
                        <div id="search-bar">
                            <span id="search-button" class="ui-state-default" title="search">
                                <span class="ui-icon ui-icon-search"></span>
                            </span>
                            <input id="search-text-input" type="text" placeholder="Search">
                        </div>
                        <div id="control-bar">
                            <button id="add-note-button">New Note</button>
                        </div>
                    </div>
                    <div id="status-bar" class="ui-toolbar ui-widget-header ui-helper-clearfix">
                        <div id="status-msg"></div>
                    </div>
                </div>
                <div id="container">
                    <div id="bookshelf">
                        <div id="accordion">
                            <h3>Bookmarks</h3>
                            <div id="bookmark-list">
                                <ul>
                                    <li>
                                        <i class="fa fa-bookmark-o"></i>
                                        <span>Bookmark 1</span>
                                    </li>
                                </ul>
                            </div>

                            <h3>
                                Notebooks
                                <span id="all-notebook-down-btn" class="action-button">
                                    <a href="#"><i class="fa fa-caret-square-o-down"></i></a>
                                </span>
                            </h3>
                            <div id="notebook-tree"></div>
                        </div>
                    </div>
                    <div id="notebook">
                        <div id="notebook-title-bar"><span><i class="fa fa-book"></i>&nbsp;</span></div>
                        <div id="note-list" class="tableview"></div>
                        <div id="note-manage-bottom-bar"><span id="note-options"><i class="fa fa-cog"></i>&nbsp;Options</span></div>
                    </div>
                    <div id="note-editor">
                        <div id="progress-dialog"></div>
                        <input id="note-title-input" type="text" placeholder="Untitled">
                        <textarea id="note-content-editor" name="note-content-editor"></textarea>
                    </div>
                </div>
                <div id="footer"></div>
            </div>
        </div>

        <div id="create-nb-dialog" title="Create a new notebook" style="overflow: hidden;">
            <form>
                <fieldset>
                    <label for="name">Notebook Name: </label>
                    <input type="text" name="name" class="dialog-input-name text ui-widget-content">

                    <p class="validate-tips"></p>

                    <!-- Allow form submission with keyboard without duplicating the dialog button -->
                    <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
                </fieldset>
            </form>
        </div>

        <div id="rename-nb-dialog" title="Rename notebook" style="overflow: hidden;">
            <form>
                <fieldset>
                    <label for="name">Notebook Name: </label>
                    <input type="text" name="name" class="dialog-input-name text ui-widget-content">

                    <p class="validate-tips"></p>

                    <!-- Allow form submission with keyboard without duplicating the dialog button -->
                    <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
                </fieldset>
            </form>
        </div>

        <div id="create-nb-stack-dialog" title="Create a new stack" style="overflow: hidden;">
            <form>
                <fieldset>
                    <label for="name">Stack Name: </label>
                    <input type="text" name="name" class="dialog-input-name text ui-widget-content">

                    <p class="validate-tips"></p>

                    <!-- Allow form submission with keyboard without duplicating the dialog button -->
                    <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
                </fieldset>
            </form>
        </div>

        <script>
            function setContentSizeFit() {
                var newWidth = $("html").width();
                var newHeight = $("html").height() - $("#header").height() - $("#control-bar").height() - $("#footer").height();
                $("#container").height(newHeight);
                try {
                    bookshelf.fitSize(newWidth, newHeight);
                    notebook.fitSize(newWidth, newHeight);
                    noteEditor.fitSize(newWidth, newHeight);
                }
                catch (err) {}
            }

            var page = new Page();
            page.setTitle("Notebook");
            page.createNavigationBar("Notebook");
            page.setFooterText("%COPYRIGHT%");

            var brandLabel = new NavigationBarLabel("%BRAND%");
            page.navigationBar.rightContainer.pushItem(brandLabel);

            /* Initialize control bar */
            $("#add-note-button").button({
                icons: {
                    primary: "ui-icon-plus"
                }
            });

            $("#add-note-button").click(function() {
                notebook.addNote(null, null);
            });
        </script>
    </body>
</html>
